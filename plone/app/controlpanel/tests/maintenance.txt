Maintenance control panel
=========================

Test setup::

    >>> app = layer['app']
    >>> from plone.testing.z2 import Browser
    >>> browser = Browser(app)
    >>> browser.handleErrors = False
    >>> portal = layer['portal']
    >>> portal_url = portal.absolute_url()


Viewing the maintenance control panel
-------------------------------------

Login as Plone admin with the manager role:

    >>> from plone.app.testing import TEST_USER_ID, TEST_USER_PASSWORD
    >>> from plone.app.testing import setRoles
    >>> setRoles(portal, TEST_USER_ID, ['Manager'])
    >>> browser.open(portal_url + '/login_form')
    >>> browser.getControl(name='__ac_name').value = TEST_USER_ID
    >>> browser.getControl(name='__ac_password').value = TEST_USER_PASSWORD
    >>> browser.getControl(name='submit').click()

While we have manage permisssions inside the site, we don't have them at the
Zope root:

    >>> browser.open(portal_url + '/@@maintenance-controlpanel')
    Traceback (most recent call last):
    ...
    Unauthorized: You are not authorized to access this resource.

Login with a manager at the Zope root:

    >>> browser.addHeader('Authorization', 'Basic admin:secret')

See if we can manage the server now:

    >>> browser.open(portal_url + '/@@maintenance-controlpanel')
    >>> browser.url.endswith('maintenance-controlpanel')
    True

    >>> 'Zope Database' in browser.contents
    True

While we cannot test the actual packaging during tests, we can skip the actual
manage_pack method by providing a negative value for days:

    >>> browser.getControl(name='form.days').value = '-1'
    >>> browser.getControl(name="form.actions.pack").click()
    >>> browser.url.endswith('maintenance-controlpanel')
    True

We should get a status message:

    >>> 'Packed the database.' in browser.contents
    True
