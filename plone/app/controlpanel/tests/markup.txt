Markup control panel
====================

Test setup::

    >>> app = layer['app']
    >>> from plone.testing.z2 import Browser
    >>> browser = Browser(app)
    >>> browser.handleErrors = False
    >>> browser.addHeader('Authorization', 'Basic admin:secret')
    >>> portal = layer['portal']

Viewing the markup control panel
--------------------------------

    >>> browser.open('http://nohost/plone/@@markup-controlpanel')
    >>> browser.url
    'http://nohost/plone/@@markup-controlpanel'

We have two controls, one for the default type and a multi selection for
alternative formats:

    >>> browser.getControl(name='form.widgets.default_type:list').value
    ['text/html']
    >>> open('/tmp/testbrowser.html', 'w').write(browser.contents)
    >>> browser.getControl(name='form.widgets.allowed_types:list').value
    ['text/html', 'text/x-web-textile']

Click the save button without making any changes:

    >>> browser.getControl(name="form.buttons.save").click()
    >>> browser.url.endswith('markup-controlpanel')
    True

We should get a status message:

    >>> 'Changes saved.' in browser.contents
    True

Now click the cancel button:

    >>> browser.getControl(name="form.buttons.cancel").click()
    >>> browser.url.endswith('plone_control_panel')
    True

There should be still no changes:

    >>> 'Changes canceled.' in browser.contents
    True

Modifying values
----------------

    >>> browser.open('http://nohost/plone/@@markup-controlpanel')
    >>> browser.getControl(name='form.widgets.default_type:list').value = ['text/x-web-textile',]
    >>> browser.getControl(name='form.widgets.allowed_types:list').value = ['text/html', 'text/x-web-textile']
    >>> browser.getControl(name="form.buttons.save").click()
    >>> 'Changes saved' in browser.contents
    True

Verify, that the settings have actually been changed in plone.app.registry:

    >>> from zope.component import getUtility
    >>> from plone.registry.interfaces import IRegistry
    >>> from plone.app.controlpanel.interfaces import IMarkupSchema

    >>> registry = getUtility(IRegistry)
    >>> settings = registry.forInterface(IMarkupSchema)
    >>> settings.default_type
    'text/x-web-textile'
    >>> settings.allowed_types
    ('text/html', 'text/x-web-textile')

Verify, that the settings have actually been changed in the site properties:

    >>> from Products.CMFCore.utils import getToolByName
    >>> portal_properties = getToolByName(portal, "portal_properties")
    >>> site_properties = portal_properties.site_properties
    >>> site_properties.getProperty('default_contenttype')
    'text/x-web-textile'
    >>> 'text/x-web-textile' in site_properties.getProperty('forbidden_contenttypes')
    False
