<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      xml:lang="en" lang="en"
      metal:use-macro="context/prefs_main_template/macros/master"
      i18n:domain="plone">

  <!-- Users overview control panel
       ############################

       $Id$
    -->

  <div metal:fill-slot="prefs_configlet_content"
       tal:define="template_id string:@@usergroup-userprefs;
                   portal_roles view/portal_roles;
                   portal_url context/portal_url">

    <div id="region-content" class="documentEditable">

      <metal:contentviewstabs use-macro="view/usergroups_controlpanel_macros/contentviewstabs" />

      <div class="contentActions">
        &nbsp;
      </div>

      <div class="documentContent" id="content">
        <a name="documentContent"></a>

        <div metal:use-macro="context/global_statusmessage/macros/portal_message">
          Portal status message
        </div>

        <div class="configlet">
          <h1 class="documentFirstHeading"
              i18n:translate="heading_users_overview">Users Overview</h1>

          <metal:linktoploneconfig use-macro="view/usergroups_controlpanel_macros/linktoploneconfig" />

          <p i18n:translate="description_user_management">
            Click the user's name to see and change the details of a
            specific user. Click the envelope icon to send a mail to
            the user. You can also edit the e-mail addresses, and
            add/remove users.
          </p>
          <p i18n:translate="user_role_note">
            Note that roles listed here apply directly to a user.
            They do not reflect additional roles users may have due
            to group memberships.
          </p>
          <p i18n:translate="description_pas_users_listing"
             tal:condition="nothing | python:not view/searchString and not context.acl_users.canListAllUsers()">
            Note: Some or all of your PAS user source
            plugins do not allow listing of users, so you may not see
            the users defined by those plugins unless doing a specific
            search.
          </p>

          <form action=""
                name="users_add"
                method="post"
                tal:attributes="action string:$portal_url/join_form?came_from_prefs=1">

            <input class="standalone add"
                   type="submit"
                   name="form.button.AddUser"
                   value="Add New User"
                   i18n:attributes="value label_add_new_user;"
                   />
            <input type="hidden" name="form.submitted" value="1" />
          </form>

          <form action=""
                class="enableAutoFocus"
                name="users_search"
                method="post"
                tal:attributes="action string:$portal_url/$template_id"
                tal:define="batch view/searchResults;
                            many_users view/many_users">
            <input type="hidden" name="form.submitted" value="1" />

            <input type="hidden" value="b_start" name="b_start"
                   tal:attributes="value view/b_start"/>

            <table class="listing" summary="User Listing">
              <tr>
                <th colspan="6" tal:attributes="colspan python:len(portal_roles)+4">
                  <span tal:omit-tag="" i18n:translate="label_user_search">User Search</span>:
                  <input class="quickSearch"
                         type="text"
                         name="searchstring"
                         value=""
                         tal:attributes="value view/searchString;"
                         />

                  <input type="submit"
                         class="searchButton"
                         name="form.button.Search"
                         value="Search"
                         i18n:attributes="value label_search;"
                         />

                  <input type="submit"
                         class="searchButton"
                         name="form.button.FindAll"
                         value="Show all"
                         i18n:attributes="value label_showall;"
                         tal:condition="not:many_users"
                         />
                </th>
              </tr>
              <tal:block tal:condition="python:batch.length" >
                <tr>
                  <th rowspan="2" i18n:translate="listingheader_user_name">User name</th>
                  <th rowspan="2" i18n:translate="listingheader_email_address">E-mail Address</th>
                  <th colspan="3" tal:attributes="colspan python:len(portal_roles)"
                      i18n:translate="listingheader_roles">Roles</th>
                  <th rowspan="2" i18n:translate="listingheader_reset_password">Reset Password</th>
                  <th rowspan="2" i18n:translate="listingheader_remove_user">Remove user</th>
                </tr>
                <tr>
                  <th tal:repeat="portal_role portal_roles" tal:content="portal_role" i18n:translate="">Role</th>
                </tr>
              </tal:block>

              <!-- Looping on users -->

              <tal:block
                 define="user_icon_png context/portal_url/user.png;
                         mail_icon_png context/mail_icon.png"
                 repeat="this_user batch">
               <tr tal:define="oddrow repeat/this_user/odd;
                                userid this_user/userid"
                    tal:condition="this_user/is_valid_user"
                    tal:attributes="class python:'odd' if oddrow else 'even'">
                 <td>
                    <a href="prefs_user_details"
                       tal:attributes="href this_user/user_details_link">
                      <tal:block
                         replace="structure user_icon_png"
                         />&nbsp;<span tal:replace="this_user/id_and_fullname">username (full name)</span>
                    </a>
                    <input type="hidden" name="users.id:records" tal:attributes="value userid" />
                  </td>

                  <td tal:define="email this_user/email">
                    <a href="#"
                       class="link-plain"
                       tal:attributes="href string:mailto:${email}"
                       title="Send a mail to this user"
                       i18n:attributes="title title_send_mail_to_user;"
                       ><tal:block replace="structure mail_icon_png"/></a>
                    <input style="margin:2px;"
                           type="text"
                           size="15"
                           name="users.email:records"
                           value=""
                           tal:attributes="value email;
                                           disabled this_user/set_email_disabled" />
                  </td>

                  <td class="listingCheckbox"
                      tal:repeat="role_infos this_user/roles_subform_view">
                    <input type="checkbox"
                           class="noborder"
                           name="users.roles:list:records"
                           value="Manager"
                           tal:attributes="value role_infos/role_name;
                                           checked role_infos/role_checked;
                                           disabled role_infos/set_role_disabled"
                           />
                  </td>

                  <td class="listingCheckbox">
                    <input type="checkbox"
                           class="noborder"
                           name="users.resetpassword:records"
                           value=""
                           tal:attributes="value userid;
                                           disabled this_user/set_password_disabled" />
                  </td>

                  <td class="listingCheckbox">
                    <input type="checkbox"
                           class="noborder notify"
                           name="delete:list"
                           value=""
                           tal:attributes="value userid;
                                           disabled this_user/user_delete_disabled" />
                  </td>
                </tr>
              </tal:block>
              <tr tal:condition="python:batch.length == 0">
                <td tal:condition="view/searchString"
                    i18n:translate="text_nomatches"
                    style="text-align:center;">No matches</td>
                <tal:block tal:condition="not:view/searchString">
                  <td tal:condition="many_users"
                      class="discreet"
                      i18n:translate="text_no_user_searchstring"
                      style="text-align:center; font-size: 100%;">
                    Enter a username to search for
                  </td>
                  <td tal:condition="not:many_users"
                      class="discreet"
                      i18n:translate="text_no_user_searchstring_largesite"
                      style="text-align:center; font-size: 100%;">
                    Enter a username to search for, or click 'Show All'
                  </td>
                </tal:block>
              </tr>
            </table>

            <div metal:use-macro="context/batch_macros/macros/navigation" />

            <input class="context"
                   type="submit"
                   name="form.button.Modify"
                   value="Apply Changes"
                   i18n:attributes="value label_apply_changes;"
                   tal:condition="batch"
                   />

            <input tal:replace="structure context/@@authenticator/authenticator" />

          </form>

        </div>
      </div>
    </div>
  </div>
</html>

